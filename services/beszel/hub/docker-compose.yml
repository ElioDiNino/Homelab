services:
  beszel:
    image: ghcr.io/henrygd/beszel/beszel:0
    restart: always
    volumes:
      - data:/beszel_data
      - beszel-socket:/beszel_socket
    healthcheck:
      test: ["CMD", "/beszel", "health", "--url", "http://localhost:8090"]
      start_period: 5s
      interval: 120s
    environment:
      APP_URL: "https://beszel.${INTERNAL_DOMAIN:?error}"
      SHARE_ALL_SYSTEMS: true
      USER_CREATION: true
      DISABLE_PASSWORD_AUTH: true
    networks:
      - proxy-internal
    labels:
      diun.enable: true
      caddy: "beszel.{$$INTERNAL_DOMAIN}"
      caddy.reverse_proxy: "{{ upstreams 8090 }}"

  beszel-local-agent:
    image: ghcr.io/henrygd/beszel/beszel-agent:0
    restart: always
    depends_on:
      beszel:
        condition: service_healthy
    volumes:
      - data-agent:/var/lib/beszel-agent
      - beszel-socket:/beszel_socket
    healthcheck:
      test: ["CMD", "/agent", "health"]
      start_period: 5s
      interval: 120s
    secrets:
      - agent_key
      - agent_token
    environment:
      LISTEN: /beszel_socket/beszel.sock
      DOCKER_HOST: tcp://socket-proxy:2375
      HUB_URL: "https://beszel.${INTERNAL_DOMAIN:?error}"
      KEY_FILE: /run/secrets/agent_key
      TOKEN_FILE: /run/secrets/agent_token
    networks:
      - outgoing
      - socket-proxy-beszel-agent
    labels:
      diun.enable: true

secrets:
  agent_key:
    environment: BESZEL_LOCAL_AGENT_KEY
  agent_token:
    environment: BESZEL_LOCAL_AGENT_TOKEN

volumes:
  data:
  data-agent:
  beszel-socket:

networks:
  outgoing:
  proxy-internal:
    external: true
  socket-proxy-beszel-agent:
    external: true
